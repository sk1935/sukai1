# 🤖 Polymarket 预测机器人 - 系统架构说明

## 📋 目录

1. [整体架构概览](#整体架构概览)
2. [完整数据流程](#完整数据流程)
3. [各模块职责详解](#各模块职责详解)
4. [多模型融合逻辑](#多模型融合逻辑)
5. [概率归一化机制](#概率归一化机制)
6. [输出层结构](#输出层结构)
7. [流程图](#流程图)

---

## 🏗️ 整体架构概览

系统采用**五层架构设计**，从用户输入到预测输出的完整流程：

```
用户输入（URL/描述）
    ↓
【1️⃣ 事件层】EventManager - 解析输入、获取市场数据
    ↓
【2️⃣ 提示层】PromptBuilder - 生成模型提示词
    ↓
【3️⃣ 推理层】ModelOrchestrator - 并发调用多个AI模型
    ↓
【4️⃣ 融合层】FusionEngine - 加权融合预测结果
    ↓
【5️⃣ 归一化层】normalize_all_predictions - 概率归一化（多选项事件）
    ↓
【6️⃣ 输出层】OutputFormatter - 格式化中文报告
    ↓
Telegram 消息输出
```

---

## 🔄 完整数据流程

### 步骤 1：用户输入处理
- **输入**：用户发送 `/predict <事件URL>` 或直接发送 URL
- **处理**：`EventManager.parse_event_from_message()` 解析事件信息
  - 提取事件名称、slug、URL等

### 步骤 2：获取市场数据
- **调用**：`EventManager.fetch_polymarket_data()`
- **数据源优先级**：
  1. **CLOB API** (`https://clob.polymarket.com/markets?slug=<slug>`) - 最优先
  2. **Gamma API** (`/events` 端点) - fallback 1
  3. **Gamma API** (`/markets` 端点) - fallback 2
  4. **GraphQL API** - fallback 3
  5. **Web 爬取** - 最后 fallback
- **输出**：
  ```python
  {
      "question": "事件标题",
      "market_prob": 45.5,  # 市场价格概率
      "is_multi_option": False,  # 是否多选项事件
      "outcomes": [...],  # 如果是多选项，包含所有选项
      "rules": "结算规则...",
      "source": "rest_api"  # 数据来源
  }
  ```

### 步骤 3：事件分析
- **调用**：`EventAnalyzer.analyze_event()`
- **功能**：分析事件类别，为每个模型分配专门的分析维度
- **输出**：
  ```python
  {
      "category": "政治/经济/科技...",
      "dimensions": ["技术可行性", "市场风险", ...],
      "model_assignments": {
          "deepseek": {"dimension_name": "综合逻辑分析"},
          "grok": {"dimension_name": "风险与批判性思维"},
          ...
      }
  }
  ```

### 步骤 4：生成提示词
- **调用**：`PromptBuilder.build_prompt()`
- **功能**：根据事件信息和模型分配，生成专门的提示词
- **特点**：每个模型可能有不同的分析角度（综合逻辑/风险评估/技术创新等）

### 步骤 5：调用AI模型
- **调用**：`ModelOrchestrator.call_all_models()`
- **并发**：同时调用多个模型（DeepSeek、Grok、ChatGPT、Claude、Gemini等）
- **超时处理**：每个模型有独立超时，失败不影响其他模型
- **返回格式**：
  ```python
  {
      "deepseek": {
          "probability": 65.5,
          "confidence": "high",
          "reasoning": "基于技术分析..."
      },
      "grok": {...},
      ...
  }
  ```

### 步骤 6：融合预测结果
- **调用**：`FusionEngine.fuse_predictions()`
- **逻辑**：加权平均融合（详见下方"多模型融合逻辑"）

### 步骤 7：概率归一化（仅多选项事件）
- **调用**：`FusionEngine.normalize_all_predictions()`
- **功能**：确保所有选项的 AI 预测概率总和 = 100%
- **触发条件**：仅当 `is_multi_option == True` 时

### 步骤 8：格式化输出
- **调用**：`OutputFormatter.format_multi_option_prediction()` 或 `format_prediction()`
- **输出**：格式化的中文 Markdown 文本

---

## 🧩 各模块职责详解

### 1️⃣ 事件层（EventManager）

**文件**：`src/event_manager.py`

**核心职责**：
- ✅ 解析用户输入（URL、事件名称、slug）
- ✅ 从 Polymarket 获取市场数据（多种 API fallback）
- ✅ 处理单选项和多选项事件
- ✅ 识别父事件和子事件（如日期市场）
- ✅ 提取选项名称和市场价格

**关键方法**：
- `parse_event_from_message()` - 解析用户消息
- `fetch_polymarket_data()` - 获取市场数据
- `_parse_clob_market_data()` - 解析 CLOB API 响应
- `_parse_rest_market_data()` - 解析 Gamma API 响应
- `_fetch_child_markets_by_title()` - 获取子市场

**输出数据格式**：
```python
{
    "question": "事件标题",
    "market_prob": 45.5,  # 单选项：市场价格；多选项：首个选项价格
    "is_multi_option": False,
    "outcomes": [  # 仅多选项
        {
            "name": "选项A",
            "market_prob": 30.0
        },
        ...
    ],
    "rules": "结算规则...",
    "source": "rest_api"
}
```

---

### 2️⃣ 提示层（PromptBuilder）

**文件**：`src/prompt_builder.py`

**核心职责**：
- ✅ 根据事件信息生成统一的模型提示词
- ✅ 为不同模型定制分析角度（如果指定了 `model_assignment`）
- ✅ 包含事件描述、市场概率、结算规则等信息

**提示词结构**：
```
你是专业的预测分析师...

事件：{question}
当前市场价格：{market_prob}%
结算规则：{rules}

请从{维度}角度分析，给出：
1. 概率预测（0-100%）
2. 置信度（low/medium/high）
3. 推理过程（中文）
```

---

### 3️⃣ 推理层（ModelOrchestrator）

**文件**：`src/model_orchestrator.py`

**核心职责**：
- ✅ 管理多个 AI 模型的 API 调用
- ✅ 并发调用多个模型
- ✅ 处理超时和错误
- ✅ 解析模型响应（提取概率、置信度、推理）

**支持的模型**：
- DeepSeek（核心量化推理）
- Grok（市场分析）
- ChatGPT（OpenRouter）
- Claude（Anthropic）
- Gemini（Google）
- Qwen（阿里）
- 等...

**调用方式**：
- **单选项事件**：所有模型并发调用
- **多选项事件**：按选项顺序，每个选项的所有模型并发调用

---

### 4️⃣ 融合层（FusionEngine）

**文件**：`src/fusion_engine.py`

**核心职责**：
- ✅ 加权融合多个模型的预测
- ✅ 融合 AI 共识与市场概率
- ✅ 计算不确定度和分歧程度
- ✅ 生成 AI 共识观点总结

**关键方法**：
- `fuse_predictions()` - 融合单选项预测
- `normalize_all_predictions()` - 归一化多选项概率（静态方法）

---

### 5️⃣ 输出层（OutputFormatter）

**文件**：`src/output_formatter.py`

**核心职责**：
- ✅ 格式化预测结果为中文 Markdown
- ✅ 自动区分候选人型事件和条件型事件
- ✅ 生成用户友好的输出格式

**关键方法**：
- `format_prediction()` - 单选项事件输出
- `format_multi_option_prediction()` - 多选项事件输出
- `format_conditional_prediction()` - 条件型事件模板
- `classify_event_type()` - 事件类型分类

---

## 🔀 多模型融合逻辑

### 融合公式

```python
# 步骤1：计算加权平均（AI共识）
weighted_mean = Σ(probability_i × weight_i) / Σ(weight_i)

其中：
    weight_i = base_weight_i × confidence_weight_i
    base_weight_i = 模型基础权重（如 DeepSeek=2.0, Grok=1.5）
    confidence_weight_i = 置信度权重（low=1.0, medium=2.0, high=3.0）

# 步骤2：计算不确定度（加权标准差）
variance = Σ(weight_i × (probability_i - weighted_mean)²) / Σ(weight_i)
uncertainty = √(variance)

# 步骤3：融合市场概率
final_prob = MODEL_WEIGHT × weighted_mean + MARKET_WEIGHT × market_prob

其中：
    MODEL_WEIGHT = 0.8  # AI 共识权重 80%
    MARKET_WEIGHT = 0.2  # 市场价格权重 20%
```

### 示例

假设有两个模型：
- **DeepSeek**：probability=65%, confidence="high", base_weight=2.0
- **Grok**：probability=55%, confidence="medium", base_weight=1.5

计算过程：
```python
# 权重计算
DeepSeek_weight = 2.0 × 3.0 = 6.0  # high confidence
Grok_weight = 1.5 × 2.0 = 3.0      # medium confidence

# 加权平均
weighted_mean = (65 × 6.0 + 55 × 3.0) / (6.0 + 3.0)
              = (390 + 165) / 9.0
              = 61.67%

# 不确定度（简化）
uncertainty ≈ 标准差 ≈ 5.0%

# 融合市场概率（假设市场=50%）
final_prob = 0.8 × 61.67% + 0.2 × 50%
           = 49.34% + 10%
           = 59.34%
```

### 分歧程度判断

```python
if uncertainty < 3.0:  → "低"
elif uncertainty < 8.0: → "中"
else:                   → "高"
```

---

## 📊 概率归一化机制

### 功能

**仅在多选项事件中启用**，确保所有选项的 AI 预测概率总和 = 100%

### 归一化公式

```python
# 如果总和 ≠ 100%，按比例缩放
if total_before != 100:
    scale_factor = 100.0 / total_before
    normalized_prob_i = original_prob_i × scale_factor
```

### 处理逻辑

1. **提取有效 AI 预测**：
   - 优先使用 `model_only_prob`（纯AI预测）
   - 如果为 `None`，跳过该选项（不参与归一化）

2. **裁剪异常值**：
   - `> 100` → 裁剪到 100
   - `< 0` → 裁剪到 0

3. **归一化计算**：
   - 如果总和 = 0：均分（100% / 选项数）
   - 否则：按比例缩放

4. **更新不确定度**：
   - 按相同比例缩放，保持相对关系

5. **重新融合**：
   - 使用归一化后的 AI 概率重新计算 `prediction`（融合市场概率）

### 示例

**归一化前**：
```
选项A: AI=30%, 市场=25%
选项B: AI=50%, 市场=40%
选项C: AI=25%, 市场=20%
总和 = 105% ❌
```

**归一化后**：
```
选项A: AI=28.57%, 预测=27.86%, 市场=25%
选项B: AI=47.62%, 预测=46.1%, 市场=40%
选项C: AI=23.81%, 预测=23.05%, 市场=20%
总和 = 100.00% ✅
```

---

## 📝 输出层结构

### 单选项事件输出

```
📊 事件: {事件标题}

🤖 纯AI预测: {概率}% ± {不确定度}%
📈 市场价格: {市场概率}%
🧠 融合预测: {融合概率}% (80% AI + 20% 市场)
💬 摘要: {AI共识观点总结}
⚖️ 分歧程度: {低/中/高}
📜 规则: {结算规则摘要}
```

### 多选项事件输出

#### 候选人型事件（如：NBA冠军、选举结果）

**识别标准**：
- 选项名称包含人名特征（空格、首字母大写、无符号）
- 如："Oklahoma City Thunder", "Trump", "Biden"

**输出格式**：
```
📊 事件: {事件标题}

📊 归一化检查：ΣAI预测 = 100.00%

🎯 多选项预测结果:

🥇 1. {选项A}
   🤖 AI预测: {概率}% ± {不确定度}%
   📈 市场价格: {市场概率}% (+/-{差值}%)

🥈 2. {选项B}
   ...

📜 规则: {结算规则摘要}

✅ 概率归一化完成（总和=100.00%，误差≤0.0000%）
```

#### 条件型事件（如：通胀率区间、日期选项）

**识别标准**：
- 选项包含数值符号（%, <, >, $）
- 包含区间关键词（below, above, between）
- 包含日期（月份、年份、季度）
- 简单选项（Yes/No）

**输出格式**：
```
📊 条件事件预测：{事件标题}

📊 归一化检查：ΣAI预测 = 100.00%

📈 各条件预测对比

• {条件A}
  AI预测: {概率}% | 市场: {市场概率}% (AI看好/市场看好 +{差值}%)

• {条件B}
  ...

🧠 AI逻辑摘要
{摘要内容}...

🚨 市场偏离信号
• "{条件}" AI高估 (+{差值}%)
• "{条件}" 市场高估 (+{差值}%)

⚠️ 风险提示
本预测基于AI语言模型推理，不代表真实概率。
请谨慎参考，自行判断。

📜 规则
{结算规则摘要}...

✅ 概率归一化完成（总和=100.00%，误差≤0.0000%）
```

---

## 🔄 流程图

### 完整流程（文字版）

```
┌─────────────────────────────────────────────────────────────┐
│                    用户输入（Telegram）                       │
│              /predict <URL> 或直接发送 URL                    │
└────────────────────────┬──────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  【1️⃣ 事件层】EventManager                                   │
│  ├─ parse_event_from_message() - 解析输入                   │
│  ├─ fetch_polymarket_data() - 获取市场数据                  │
│  │   ├─ CLOB API (优先)                                      │
│  │   ├─ Gamma API /events                                    │
│  │   ├─ Gamma API /markets                                  │
│  │   └─ Web 爬取 (最后)                                     │
│  └─ 输出: event_data {question, market_prob, outcomes...}   │
└────────────────────────┬──────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  【事件分析】EventAnalyzer                                   │
│  ├─ analyze_event() - 分析事件类别                          │
│  └─ 输出: model_assignments {模型名: {维度}}                │
└────────────────────────┬──────────────────────────────────────┘
                         │
                         ▼
                    ┌─────────┐
                    │单选项？  │
                    └────┬────┘
                         │
         ┌───────────────┴───────────────┐
         │                                │
       是│                                │否
         │                                │
         ▼                                ▼
┌──────────────────┐         ┌──────────────────────────────────┐
│  【单选项流程】    │         │  【多选项流程】                   │
│                  │         │                                  │
│ ┌──────────────┐ │         │ for outcome in outcomes:        │
│ │【2️⃣ 提示层】 │ │         │   ┌────────────────────────────┐ │
│ │PromptBuilder │ │         │   │【2️⃣ 提示层】              │ │
│ │build_prompt()│ │         │   │PromptBuilder              │ │
│ └──────┬───────┘ │         │   │为每个选项生成提示词          │ │
│        │         │         │   └──────┬─────────────────────┘ │
│        ▼         │         │          │                        │
│ ┌──────────────┐ │         │          ▼                        │
│ │【3️⃣ 推理层】 │ │         │   ┌────────────────────────────┐ │
│ │ModelOrch.   │ │         │   │【3️⃣ 推理层】              │ │
│ │call_all_    │ │         │   │ModelOrchestrator           │ │
│ │models()     │ │         │   │并发调用所有模型              │ │
│ │(并发调用)    │ │         │   └──────┬─────────────────────┘ │
│ └──────┬───────┘ │         │          │                        │
│        │         │         │          ▼                        │
│        ▼         │         │   ┌────────────────────────────┐ │
│ ┌──────────────┐ │         │   │【4️⃣ 融合层】              │ │
│ │【4️⃣ 融合层】 │ │         │   │FusionEngine               │ │
│ │FusionEngine  │ │         │   │fuse_predictions()          │ │
│ │fuse_        │ │         │   │为每个选项融合预测            │ │
│ │predictions()│ │         │   └──────┬─────────────────────┘ │
│ └──────┬───────┘ │         │          │                        │
│        │         │         │          │                        │
│        │         │         │          ▼                        │
│        │         │         │   ┌────────────────────────────┐ │
│        │         │         │   │收集所有选项的融合结果        │ │
│        │         │         │   └──────┬─────────────────────┘ │
│        │         │         │          │                        │
│        │         │         │          ▼                        │
│        │         │         │   ┌────────────────────────────┐ │
│        │         │         │   │【5️⃣ 归一化层】            │ │
│        │         │         │   │normalize_all_              │ │
│        │         │         │   │predictions()               │ │
│        │         │         │   │使总和=100%                 │ │
│        │         │         │   └──────┬─────────────────────┘ │
│        │         │         │          │                        │
│        │         │         └──────────┼────────────────────────┘
│        │         │                    │
│        │         └────────────────────┘
│        │                           │
│        └──────────────────────────┘
│                              │
│                              ▼
│              ┌───────────────────────────────┐
│              │【6️⃣ 输出层】OutputFormatter    │
│              │                                │
│              │ classify_event_type()          │
│              │ ├─ candidate?                 │
│              │ │  └─ format_multi_option     │
│              │ │      (名次格式)              │
│              │ └─ conditional?               │
│              │    └─ format_conditional     │
│              │       (趋势格式)              │
│              └────────────┬───────────────────┘
│                           │
│                           ▼
│              ┌───────────────────────────────┐
│              │   格式化中文 Markdown 文本      │
│              │   包含：归一化检查、预测结果、   │
│              │   摘要、偏离信号、风险提示      │
│              └────────────┬───────────────────┘
│                           │
│                           ▼
│              ┌───────────────────────────────┐
│              │     Telegram 消息发送           │
│              └────────────────────────────────┘
```

### 关键决策点

1. **事件类型判断**：单选项 vs 多选项
2. **数据源选择**：CLOB API → Gamma API → Web 爬取
3. **事件分类**：候选人型 vs 条件型（仅多选项）
4. **归一化触发**：仅多选项事件

---

## 📌 总结

### 系统特点

1. **五层架构**：清晰分层，职责明确
2. **多模型融合**：加权平均 + 市场融合（80% AI + 20% 市场）
3. **概率归一化**：确保多选项事件 AI 预测总和 = 100%
4. **智能输出**：自动区分候选人型和条件型事件，使用不同模板
5. **容错机制**：多层 fallback，确保系统稳定性

### 关键数据流

```
用户输入 → 事件解析 → 市场数据获取 → 事件分析 → 提示词生成 
→ 模型调用 → 预测融合 → 概率归一化 → 格式化输出 → Telegram
```

### 核心公式

```python
# 融合公式
final_prob = 0.8 × weighted_mean + 0.2 × market_prob

# 归一化公式（多选项）
normalized_prob_i = original_prob_i × (100.0 / Σ(original_probs))
```

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护者**：系统架构文档



