"""
æç¤ºå±‚ï¼ˆPrompt Builderï¼‰ï¼š
æ ¹æ® OPTIMIZATION_NOTES.md çš„äº”å±‚æ¶æ„è®¾è®¡

èŒè´£ï¼š
- æ ¹æ®äº‹ä»¶ä¿¡æ¯ç”Ÿæˆå¤šæ¨¡å‹ç»Ÿä¸€æç¤ºè¯
- æ¯ä¸ªæ¨¡å‹ä½¿ç”¨åŒä¸€äº‹ä»¶æè¿°ï¼Œä½†å¯ä»¥æ ¹æ®æ¨¡å‹ç‰¹æ€§è°ƒæ•´è§’åº¦
- é€šè¿‡ EventAnalyzer è·å–æ¨¡å‹ä»»åŠ¡åˆ†å·¥ï¼Œç”Ÿæˆä¸“ä¸šåŒ–æç¤º
- é›†æˆä¸–ç•Œæ¸©åº¦å’Œæ–°é—»æ‘˜è¦ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰

è¾“å…¥ï¼šäº‹ä»¶æ•°æ® {question, rules, market_prob, days_left, world_temp, news_summary}
è¾“å‡ºï¼šå„æ¨¡å‹çš„è¾“å…¥ promptï¼ˆå­—ç¬¦ä¸²ï¼‰
"""
import sys
from pathlib import Path
from typing import Dict, Optional
import asyncio

# Add project root to path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from prompt_templates import PROMPT_TEMPLATE, SPECIALIZED_PROMPT_TEMPLATE, DIMENSION_TEMPLATES

# å¯¼å…¥æ–°é—»æ‘˜è¦ï¼ˆå¦‚æœå¯ç”¨ï¼‰
try:
    from src.openrouter_assistant import get_news_summary
    NEWS_SUMMARY_AVAILABLE = True
except ImportError:
    NEWS_SUMMARY_AVAILABLE = False


class PromptBuilder:
    """
    Builds specialized prompts for different model dimensions.
    
    æ ¹æ®äº‹ä»¶æ•°æ®å’Œæ¨¡å‹åˆ†å·¥ï¼Œæ„å»ºä¸“ä¸šåŒ–æç¤ºè¯ã€‚
    æ”¯æŒï¼š
    - ä¸“ä¸šåŒ–ç»´åº¦æç¤ºï¼ˆé€šè¿‡ EventAnalyzer åˆ†é…ä»»åŠ¡ï¼‰
    - é€šç”¨æ¨¡æ¿æç¤ºï¼ˆfallbackï¼‰
    - æ‰€æœ‰æç¤ºè¦æ±‚æ¨¡å‹ä½¿ç”¨ä¸­æ–‡è¾“å‡º
    """
    
    def __init__(self):
        pass
    
    def _build_world_temp_section(self, event_data: Dict) -> str:
        """æ„å»ºä¸–ç•Œæ¸©åº¦éƒ¨åˆ†ï¼ˆå¦‚æœå¯ç”¨ï¼‰"""
        world_temp = event_data.get("world_temp")
        world_sentiment_summary = event_data.get("world_sentiment_summary")
        
        # ã€ä¿®å¤ã€‘ç¡®ä¿ world_temp ä¸ä¸º None ä¸”ä¸ºæ•°å€¼ç±»å‹
        if world_temp is not None:
            try:
                world_temp_val = float(world_temp)
                temp_desc = ""
                if world_temp_val > 20:
                    temp_desc = "éå¸¸ç§¯æ"
                elif world_temp_val > 10:
                    temp_desc = "è¾ƒä¸ºç§¯æ"
                elif world_temp_val > 0:
                    temp_desc = "ç•¥å¾®ç§¯æ"
                elif world_temp_val > -10:
                    temp_desc = "ç•¥å¾®æ¶ˆæ"
                elif world_temp_val > -20:
                    temp_desc = "è¾ƒä¸ºæ¶ˆæ"
                else:
                    temp_desc = "éå¸¸æ¶ˆæ"
                
                section = f"- Global Sentiment Temperature: {world_temp_val:.2f} ({temp_desc})"
                if world_sentiment_summary:
                    section += f"\n  {world_sentiment_summary}"
                return section
            except (TypeError, ValueError):
                print("âš ï¸ world_temp æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡æ ¼å¼åŒ–")
                return ""
        return ""
    
    def _build_news_summary_section(self, event_data: Dict) -> str:
        """æ„å»ºæ–°é—»æ‘˜è¦éƒ¨åˆ†ï¼ˆå¦‚æœå¯ç”¨ï¼‰"""
        # ä¼˜å…ˆä» event_data è·å–
        news_summary = event_data.get("news_summary")
        
        if news_summary:
            return f"- Recent Global News Summary:\n  {news_summary[:500]}"  # é™åˆ¶é•¿åº¦
        
        # å¦‚æœæ²¡æœ‰ï¼Œå°è¯•ä» openrouter_assistant è·å–ï¼ˆå¼‚æ­¥ï¼‰
        if NEWS_SUMMARY_AVAILABLE:
            try:
                # æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥ä½¿ç”¨ awaitï¼Œå› ä¸º build_prompt æ˜¯åŒæ­¥å‡½æ•°
                # å¯ä»¥è€ƒè™‘åœ¨è°ƒç”¨ build_prompt ä¹‹å‰é¢„å…ˆè·å– news_summary
                pass
            except:
                pass
        
        return ""
    
    def build_prompt(self, event_data: Dict, model_name: str, model_assignment: Optional[Dict] = None) -> str:
        """
        Build a specialized prompt for a specific model.
        
        Args:
            event_data: Dict with 'question', 'rules', 'market_prob', 'days_left', 
                       'world_temp', 'news_summary' (optional)
            model_name: Name of the model
            model_assignment: Optional dict with dimension assignment from EventAnalyzer
        
        Returns:
            Formatted prompt string
        """
        # ã€æ–°å¢ã€‘æ·»åŠ è°ƒè¯•æ—¥å¿—
        print(f"[PromptBuilder] ğŸ¯ ä¸ºæ¨¡å‹ {model_name} æ„å»ºæç¤ºè¯")
        
        # æ„å»ºä¸–ç•Œæ¸©åº¦å’Œæ–°é—»æ‘˜è¦éƒ¨åˆ†
        world_temp_section = self._build_world_temp_section(event_data)
        news_summary_section = self._build_news_summary_section(event_data)
        
        # ã€æ–°å¢ã€‘æ—¥å¿—è¾“å‡ºå…¨çƒä¸Šä¸‹æ–‡ä¿¡æ¯
        # ã€ä¿®å¤ã€‘æ£€æŸ¥ world_temp æ˜¯å¦ä¸º None å†æ ¼å¼åŒ–
        world_temp = event_data.get("world_temp")
        if world_temp is not None:
            try:
                print(f"[PromptBuilder] ğŸŒ åŒ…å«ä¸–ç•Œæ¸©åº¦: {float(world_temp):.2f}")
            except (TypeError, ValueError):
                print("âš ï¸ [PromptBuilder] world_temp æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡æ ¼å¼åŒ–")
        if event_data.get("news_summary"):
            print(f"[PromptBuilder] ğŸ“° å·²æ³¨å…¥æ–°é—»æ‘˜è¦ ({len(event_data['news_summary'])} å­—ç¬¦)")
        
        # å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
        if not world_temp_section and not news_summary_section:
            world_temp_section = ""
            news_summary_section = ""
        
        # If we have a specialized assignment, use it
        if model_assignment:
            prompt = SPECIALIZED_PROMPT_TEMPLATE.format(
                specialization_name=model_assignment.get("specialization", "Forecasting"),
                dimension_name=model_assignment.get("dimension_name", "General Analysis"),
                dimension_description=model_assignment.get("dimension_description", "Analyze the event"),
                event_title=event_data.get("question", ""),
                event_rules=event_data.get("rules", ""),
                market_prob=event_data.get("market_prob", 50.0),
                days_left=event_data.get("days_left", 30),
                world_temp_section=world_temp_section or "(No global sentiment data available)",
                news_summary_section=news_summary_section or "(No news summary available)"
            )
        else:
            # Fallback to generic template
            dimension = DIMENSION_TEMPLATES.get(
                model_name,
                "General forecasting analysis"
            )
            
            prompt = PROMPT_TEMPLATE.format(
                event_title=event_data.get("question", ""),
                event_rules=event_data.get("rules", ""),
                market_prob=event_data.get("market_prob", 50.0),
                days_left=event_data.get("days_left", 30),
                dimension_description=dimension,
                world_temp_section=world_temp_section or "(No global sentiment data available)",
                news_summary_section=news_summary_section or "(No news summary available)"
            )
        
        # ã€æ–°å¢ã€‘æç¤ºè¯ç”Ÿæˆå®Œæˆæ—¥å¿—
        print(f"[PromptBuilder] âœ… æç¤ºè¯ç”Ÿæˆå®Œæˆ ({len(prompt)} å­—ç¬¦)")
        
        return prompt

