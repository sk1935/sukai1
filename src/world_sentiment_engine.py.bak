"""
ä¸–ç•Œæƒ…ç»ªå¼•æ“

åŠŸèƒ½ï¼š
- ä» news_cache.json è¯»å–æ–°é—»æ•°æ®
- è®¡ç®—å…¨çƒèˆ†æƒ…æ¸©åº¦ (World Temperature Index)
- ç»Ÿè®¡æƒ…ç»ªåˆ†å¸ƒ
- è®¡ç®—è¶‹åŠ¿ï¼ˆä¸Šå‡/ä¸‹é™/ç¨³å®šï¼‰
"""
import json
from datetime import datetime, timezone, timedelta
from pathlib import Path
from typing import Dict, Optional, List
import sys

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# ç›¸å¯¹å¯¼å…¥ï¼ˆåŒç›®å½•ï¼‰
from src.news_cache import CACHE_FILE, load_cache

WORLD_SENTIMENT_ENABLED = False  # Stability mode toggle


def compute_world_temperature() -> Optional[Dict]:
    """
    è®¡ç®—å…¨çƒèˆ†æƒ…æ¸©åº¦
    
    å…¬å¼: WTI = (æ­£é¢ - è´Ÿé¢) / æ€»æ ·æœ¬ Ã— 100
    
    Returns:
        Dict: {
            "world_temp": float,  # ä¸–ç•Œæ¸©åº¦æŒ‡æ•°ï¼ŒèŒƒå›´ [-100, 100]
            "trend": str,         # "rising", "falling", "stable"
            "sentiment_distribution": {
                "pos": int,       # æ­£é¢æ–°é—»æ•°é‡
                "neg": int,       # è´Ÿé¢æ–°é—»æ•°é‡
                "neu": int        # ä¸­æ€§æ–°é—»æ•°é‡
            }
        }
        å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œè¿”å› None
    """
    if not WORLD_SENTIMENT_ENABLED:
        print("ğŸ›‘ [WORLD_SENTIMENT] åŠŸèƒ½å·²ç¦ç”¨ï¼Œè·³è¿‡ä¸–ç•Œæ¸©åº¦è®¡ç®—")
        return None
    try:
        # åŠ è½½ç¼“å­˜
        cached_data = load_cache()
        
        if not cached_data or not cached_data.get("news"):
            print("âš ï¸ æ–°é—»ç¼“å­˜ä¸ºç©ºï¼Œæ— æ³•è®¡ç®—ä¸–ç•Œæ¸©åº¦")
            return None
        
        news_list = cached_data["news"]
        
        if not news_list:
            print("âš ï¸ æ–°é—»åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•è®¡ç®—ä¸–ç•Œæ¸©åº¦")
            return None
        
        # ç»Ÿè®¡æƒ…ç»ªåˆ†å¸ƒ
        pos_count = 0  # æ­£é¢ï¼ˆsentiment_score > 0.1ï¼‰
        neg_count = 0  # è´Ÿé¢ï¼ˆsentiment_score < -0.1ï¼‰
        neu_count = 0  # ä¸­æ€§ï¼ˆ-0.1 <= sentiment_score <= 0.1ï¼‰
        
        total_sentiment = 0.0
        
        for news_item in news_list:
            sentiment_score = news_item.get("sentiment_score", 0.0)
            total_sentiment += sentiment_score
            
            if sentiment_score > 0.1:
                pos_count += 1
            elif sentiment_score < -0.1:
                neg_count += 1
            else:
                neu_count += 1
        
        # è®¡ç®—ä¸–ç•Œæ¸©åº¦æŒ‡æ•° (World Temperature Index)
        total_count = len(news_list)
        if total_count == 0:
            return None
        
        # WTI = (æ­£é¢ - è´Ÿé¢) / æ€»æ ·æœ¬ Ã— 100
        wti = ((pos_count - neg_count) / total_count) * 100
        
        # è®¡ç®—è¶‹åŠ¿ï¼ˆå¯¹æ¯”å¹³å‡æƒ…æ„Ÿåˆ†æ•°ï¼‰
        avg_sentiment = total_sentiment / total_count if total_count > 0 else 0.0
        
        # åˆ¤æ–­è¶‹åŠ¿
        if avg_sentiment > 0.1:
            trend = "rising"
        elif avg_sentiment < -0.1:
            trend = "falling"
        else:
            trend = "stable"
        
        result = {
            "world_temp": round(wti, 2),
            "trend": trend,
            "sentiment_distribution": {
                "pos": pos_count,
                "neg": neg_count,
                "neu": neu_count
            },
            "total_samples": total_count,
            "avg_sentiment_score": round(avg_sentiment, 3)
        }
        
        # ã€é˜²å¾¡ã€‘ç¡®ä¿ world_temp ä¸ä¸º None å†æ ¼å¼åŒ–
        world_temp_val = result.get("world_temp")
        if world_temp_val is None:
            print("âš™ï¸ [SAFE] ä¿®å¤ç©ºå€¼ä¿æŠ¤: world_temp_val")
            world_temp_val = 0.0
        if world_temp_val is not None:
            world_temp_val = world_temp_val or 0.0
            if world_temp_val is None:
                world_temp_val = 0.0
            print(f"ğŸŒ ä¸–ç•Œæ¸©åº¦è®¡ç®—å®Œæˆ: WTI = {(world_temp_val or 0.0):.2f}, è¶‹åŠ¿ = {trend}")
            print(f"   æƒ…ç»ªåˆ†å¸ƒ: æ­£é¢ {pos_count}, è´Ÿé¢ {neg_count}, ä¸­æ€§ {neu_count}")
        else:
            print(f"âš ï¸ ä¸–ç•Œæ¸©åº¦è®¡ç®—å®Œæˆï¼Œä½† world_temp ä¸º None")
        
        return result
        
    except Exception as e:
        print(f"âŒ è®¡ç®—ä¸–ç•Œæ¸©åº¦æ—¶å‡ºé”™: {type(e).__name__}: {e}")
        return None


def get_world_temperature_summary(world_temp_data: Optional[Dict]) -> str:
    """
    ç”Ÿæˆä¸–ç•Œæ¸©åº¦çš„æ–‡æœ¬æ‘˜è¦
    
    Args:
        world_temp_data: compute_world_temperature() çš„è¿”å›ç»“æœ
    
    Returns:
        str: äººç±»å¯è¯»çš„æ‘˜è¦æ–‡æœ¬
    """
    if not WORLD_SENTIMENT_ENABLED:
        return "ä¸–ç•Œæ¸©åº¦æ•°æ®æš‚æœªå¯ç”¨"
    if not world_temp_data:
        return "ä¸–ç•Œæ¸©åº¦æ•°æ®ä¸å¯ç”¨"
    
    wti = world_temp_data.get("world_temp")
    # ã€ä¿®å¤ã€‘æ£€æŸ¥ world_temp æ˜¯å¦ä¸º None
    if wti is None:
        print("âš ï¸ world_temp æ•°æ®ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼ 0.0")
        wti = 0.0
    
    trend = world_temp_data.get("trend", "stable")
    dist = world_temp_data.get("sentiment_distribution", {})
    
    # ç”Ÿæˆè¶‹åŠ¿æè¿°
    trend_map = {
        "rising": "ä¸Šå‡",
        "falling": "ä¸‹é™",
        "stable": "ç¨³å®š"
    }
    trend_cn = trend_map.get(trend, "ç¨³å®š")
    
    # ç”Ÿæˆæ¸©åº¦æè¿°
    if wti > 20:
        temp_desc = "éå¸¸ç§¯æ"
    elif wti > 10:
        temp_desc = "è¾ƒä¸ºç§¯æ"
    elif wti > 0:
        temp_desc = "ç•¥å¾®ç§¯æ"
    elif wti > -10:
        temp_desc = "ç•¥å¾®æ¶ˆæ"
    elif wti > -20:
        temp_desc = "è¾ƒä¸ºæ¶ˆæ"
    else:
        temp_desc = "éå¸¸æ¶ˆæ"
    
    # ã€é˜²å¾¡ã€‘ç¡®ä¿ wti ä¸ä¸º None
    wti = wti or 0.0
    if wti is None:
        print("âš ï¸ wti is None, using default 0.0")
        wti = 0.0
    summary = (
        f"å…¨çƒèˆ†æƒ…æ¸©åº¦æŒ‡æ•° (WTI): {(wti or 0.0):.2f} ({temp_desc})ï¼Œ"
        f"è¶‹åŠ¿: {trend_cn}ã€‚"
        f"æƒ…ç»ªåˆ†å¸ƒ: æ­£é¢ {dist.get('pos', 0)} æ¡ï¼Œ"
        f"è´Ÿé¢ {dist.get('neg', 0)} æ¡ï¼Œ"
        f"ä¸­æ€§ {dist.get('neu', 0)} æ¡ã€‚"
    )
    
    return summary


# å¯¼å‡ºå‡½æ•°
__all__ = [
    "compute_world_temperature",
    "get_world_temperature_summary"
]
